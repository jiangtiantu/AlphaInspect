# 累计收益计算方法

## (pct_change*weights+1).cumprod()的不足

多头计算正确，空头计算失真。例如

```text
价  格:1 -> 1.5 -> 2
收益率: 0.5 -> 0.3333
多头收益 1 -> 1.5 -> 2
空头收益 1 -> 0.5 -> 0.333
```

只在第一天入场交易，之后只持有不调仓。

即空头收益第一步0.5是正确的，第二步0.333错了，应当是0才对。其实早已经破产

而这里的结果其实是每天调仓。第二步时再调仓时由于资金减少，所以跌33.3%时并不会破产

## 对数收益率的不足

时序上可以累加，并且可以还原成简单收益率。累加比累乘快，非常好用。
但横截面上却无法累加，也就无法求平均。所以无法计算等权

## 市值+现金流

思考再三，这个方法应当能处理空头问题，还是同一问题

```text
价  格:1 -> 1.5 -> 2
收益率: 0.5 -> 0.3333
多头持仓市值: 1 -> 1.5 -> 2
开仓现金流: -1 -> -1 -> -1
盈利: 0 -> 0.5 -> 1
```

平时我们只注意了持仓市值，而现金流一直没有留意

```text
价  格:1 -> 1.5 -> 2
收益率: 0.5 -> 0.3333
空头持仓市值: -1 -> -1.5 -> -2
开仓现金流: -1 -> -1 -> -1
盈利: 0 -> -0.5 -> -1
```

空头虽然正确，但起始两个-1，为何不能是1呢？做一下调整

```text
价  格:1 -> 1.5 -> 2
收益率: 0.5 -> 0.3333
空头持仓市值: -1 -> -1.5 -> -2
开仓现金流: 2 -> 2 -> 2
盈利: 0 -> -0.5 -> -1
```

这样起始就为1了。

同样多头也做成起始为1。

```text
价  格:1 -> 1.5 -> 2
收益率: 0.5 -> 0.3333
多头持仓市值: 1 -> 1.5 -> 2
开仓现金流: 0 -> 0 -> 0
盈利: 0 -> 0.5 -> 1
```

现金流改成了0，正好我们平时也忽略此值

## 因子产生频与持有期不对应怎么办？

如何计算持有5期的收益率呢？5期收益难道忽略中间4期的因子信号吗？不同的起始入场点会得到不同的累计收益怎么处理？

多方参考后的处理方法是：将资金平均分成5份，每天入场1份，每份都是持有5天后再调仓，然后得到每份的累计收益区线。将5条曲线合并成最终的累计收益曲线